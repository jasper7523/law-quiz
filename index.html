<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>åœ‹è€ƒçˆ­é»ç·´ç¿’å™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff; --primary-hover: #0056b3; --correct-bg: #d4edda;
            --correct-text: #155724; --wrong-bg: #f8d7da; --wrong-text: #721c24;
            --missed-bg: #fff3cd; --missed-text: #856404; --light-gray: #f4f4f9;
            --medium-gray: #ddd; --dark-gray: #333;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; margin: 0; padding: 15px; background-color: var(--light-gray); color: var(--dark-gray); }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        h1, h2, h3 { color: #444; }
        h1 { text-align: center; }
        .question-area, .feedback-area { margin-top: 15px; padding: 15px; border: 1px solid var(--medium-gray); border-radius: 5px; background-color: #fafafa; }
        .choices div { margin: 10px 0; }
        .choices label { display: block; padding: 12px; border: 1px solid #ccc; border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; user-select: none; }
        .choices label:hover { background-color: #f0f0f0; }
        .choices input[type="checkbox"] { display: none; }
        .choices input[type="checkbox"]:checked + span { color: var(--primary-color); font-weight: bold; }
        .choices input[type="checkbox"]:checked + span::before { content: 'âœ“ '; font-family: sans-serif; }
        .choices label.checked { border-color: var(--primary-color); background-color: #e7f3ff; }
        .choices input[type="checkbox"]:disabled + span { cursor: not-allowed; color: #888; }
        .choices label.disabled { background-color: #e9ecef; cursor: not-allowed; opacity: 0.7; }
        button { display: block; width: 100%; padding: 15px; font-size: 16px; font-weight: bold; color: #fff; background-color: var(--primary-color); border: none; border-radius: 8px; cursor: pointer; margin-top: 20px; transition: background-color 0.2s; -webkit-appearance: none; }
        button:hover { background-color: var(--primary-hover); }
        #loading-message, #status-message { font-size: 18px; text-align: center; padding: 40px; color: #666; }
        .feedback-item { margin: 8px 0; padding: 10px; border-radius: 5px; }
        .feedback-correct { color: var(--correct-text); background-color: var(--correct-bg); }
        .feedback-wrong { color: var(--wrong-text); background-color: var(--wrong-bg); }
        .feedback-missed { color: var(--missed-text); background-color: var(--missed-bg); }
        .log-status { font-size: 0.9em; text-align: right; color: #888; margin-top: 5px; height: 1.2em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>åœ‹è€ƒçˆ­é»ç·´ç¿’å™¨</h1>
        <div id="loading-message">ğŸ”„ æ­£åœ¨å¾æ‚¨çš„Googleé›²ç«¯ç¡¬ç¢Ÿè®€å–é¡Œåº«...</div>
        <div id="status-message" style="display:none;"></div>
        <div id="quiz-area" style="display: none;">
            <div class="question-area">
                <h3 id="question-title"></h3>
                <p id="question-scenario" style="white-space: pre-wrap;"></p>
            </div>
            <div class="quiz-section">
                <h2>å•é¡Œä¸€ï¼šè€ƒé»</h2>
                <div id="choices-è€ƒé»" class="choices"></div>
            </div>
            <div class="quiz-section">
                <h2>å•é¡ŒäºŒï¼šé—œéµå­—</h2>
                <div id="choices-é—œéµå­—" class="choices"></div>
            </div>
            <button id="submit-btn">é€å‡ºç­”æ¡ˆ</button>
            <div id="feedback-area" class="feedback-area" style="display: none;"></div>
            <button id="next-btn" style="display: none; background-color: #28a745;">ä¸‹ä¸€é¡Œ</button>
        </div>
    </div>

    <script>
        // â–¼â–¼â–¼ 1. è«‹å¡«å…¥æ‚¨çš„ã€Œé¡Œåº«ã€è©¦ç®—è¡¨ .csv ç™¼ä½ˆé€£çµ â–¼â–¼â–¼
        const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSt819mIxMjqR3L57o5RlmmXPuk99UOT_o3rBxVNFn9ecQUGavKRZRqnEfumK4hPA7CW9wi-kB_bMub/pub?gid=1432079927&single=true&output=csv";
        
        // â–¼â–¼â–¼ 2. è«‹å¡«å…¥æ‚¨åœ¨ç¬¬äºŒæ­¥ä¸­å–å¾—çš„ã€ŒApps Script ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€ã€ â–¼â–¼â–¼
        const errorLogApiUrl = "";
        
        let allData = [], questionPool = [], currentQuestion = {};
        let correctè€ƒé»Indices = [], correcté—œéµå­—Indices = [];
        const loadingMessage = document.getElementById('loading-message');
        const statusMessage = document.getElementById('status-message');
        const quizArea = document.getElementById('quiz-area');
        const questionTitle = document.getElementById('question-title');
        const questionScenario = document.getElementById('question-scenario');
        const choicesè€ƒé» = document.getElementById('choices-è€ƒé»');
        const choicesé—œéµå­— = document.getElementById('choices-é—œéµå­—');
        const submitBtn = document.getElementById('submit-btn');
        const nextBtn = document.getElementById('next-btn');
        const feedbackArea = document.getElementById('feedback-area');

        function randint(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

        function parseAnswer(answerStr) {
            if (typeof answerStr !== 'string') return {è€ƒé»: [], é—œéµå­—: []};
            const è€ƒé»Match = answerStr.match(/ã€è€ƒé»ã€‘\s*([\s\S]*?)(?=\n\nã€é—œéµå­—ã€‘|$)/);
            const é—œéµå­—Match = answerStr.match(/ã€é—œéµå­—ã€‘\s*([\s\S]*)/);
            const è€ƒé»Text = è€ƒé»Match ? è€ƒé»Match[1].trim() : "";
            const é—œéµå­—Text = é—œéµå­—Match ? é—œéµå­—Match[1].trim() : "";
            const è€ƒé»List = è€ƒé»Text ? [...new Set(è€ƒé»Text.split(/[ã€\s\n/()]+/).filter(item => item && item.trim()))] : [];
            const é—œéµå­—List = é—œéµå­—Text ? [...new Set(é—œéµå­—Text.split(/[ã€\s\n/()]+/).filter(item => item && item.trim()))] : [];
            return { è€ƒé»: è€ƒé»List, é—œéµå­—: é—œéµå­—List };
        }
        
        function generateChoices(correctItems, pool, numChoices = 5) {
            const numCorrect = Math.max(1, Math.min(correctItems.length, randint(2, 3)));
            const selectedCorrect = [...correctItems].sort(() => 0.5 - Math.random()).slice(0, numCorrect);
            const numDistractors = numChoices - selectedCorrect.length;
            const distractorsPool = pool.filter(item => !correctItems.includes(item));
            const selectedDistractors = [...distractorsPool].sort(() => 0.5 - Math.random()).slice(0, numDistractors);
            const choices = [...selectedCorrect, ...selectedDistractors].sort(() => 0.5 - Math.random());
            const correctIndices = choices.map((choice, i) => correctItems.includes(choice) ? i : -1).filter(i => i !== -1);
            return { choices, correctIndices };
        }

        function displayQuestion() {
            if (questionPool.length === 0) {
                quizArea.innerHTML = '<h1>ğŸ‰ æ­å–œï¼æ‰€æœ‰é¡Œç›®éƒ½ç·´ç¿’å®Œç•¢äº†ï¼</h1><p style="text-align:center;">æ‚¨å¯ä»¥é‡æ–°æ•´ç†é é¢ä¾†é€²è¡Œæ–°ä¸€è¼ªçš„ç·´ç¿’ã€‚</p>';
                quizArea.style.display = 'block';
                return;
            }
            const qIndex = questionPool.pop();
            currentQuestion = allData[qIndex];
            
            const parsed = parseAnswer(currentQuestion.answer);
            const allè€ƒé» = [...new Set(allData.flatMap(q => parseAnswer(q.answer).è€ƒé»))];
            const allé—œéµå­— = [...new Set(allData.flatMap(q => parseAnswer(q.answer).é—œéµå­—))];

            const è€ƒé»Data = generateChoices(parsed.è€ƒé», allè€ƒé»);
            const é—œéµå­—Data = generateChoices(parsed.é—œéµå­—, allé—œéµå­—);

            correctè€ƒé»Indices = è€ƒé»Data.correctIndices;
            correcté—œéµå­—Indices = é—œéµå­—Data.correctIndices;

            questionTitle.innerText = currentQuestion.title;
            questionScenario.innerText = currentQuestion.scenario;
            
            choicesè€ƒé».innerHTML = è€ƒé»Data.choices.map((c, i) => `<div><label><input type="checkbox" name="è€ƒé»" value="${i}"> <span>${c}</span></label></div>`).join('');
            choicesé—œéµå­—.innerHTML = é—œéµå­—Data.choices.map((c, i) => `<div><label><input type="checkbox" name="é—œéµå­—" value="${i}"> <span>${c}</span></label></div>`).join('');
            
            document.querySelectorAll('.choices input').forEach(el => {
                el.addEventListener('change', (e) => {
                    e.target.parentElement.classList.toggle('checked', e.target.checked);
                });
            });

            feedbackArea.style.display = 'none';
            feedbackArea.innerHTML = '';
            submitBtn.style.display = 'block';
            nextBtn.style.display = 'none';
            quizArea.style.display = 'block';
        }

        submitBtn.addEventListener('click', () => {
            document.querySelectorAll('.choices input[type="checkbox"]').forEach(checkbox => {
                checkbox.disabled = true;
                checkbox.parentElement.classList.add('disabled');
            });

            const userè€ƒé» = [...document.querySelectorAll('input[name="è€ƒé»"]:checked')].map(el => parseInt(el.value));
            const useré—œéµå­— = [...document.querySelectorAll('input[name="é—œéµå­—"]:checked')].map(el => parseInt(el.value));
            
            let feedbackHTML = '<h3>çµæœåˆ†æ</h3>';
            feedbackHTML += grade(userè€ƒé», correctè€ƒé»Indices, document.querySelectorAll('#choices-è€ƒé» span'), 'è€ƒé»');
            feedbackHTML += grade(useré—œéµå­—, correcté—œéµå­—Indices, document.querySelectorAll('#choices-é—œéµå­— span'), 'é—œéµå­—');

            feedbackArea.innerHTML = feedbackHTML;
            feedbackArea.style.display = 'block';
            submitBtn.style.display = 'none';
            nextBtn.style.display = 'block';
        });

        async function logError(logData) {
            if (!errorLogApiUrl) {
                return { success: false, message: 'API URL æœªè¨­å®š' };
            }
            try {
                const response = await fetch(errorLogApiUrl, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(logData),
                    redirect: 'follow'
                });
                const result = await response.json();
                return { success: result.result === 'success', message: result.message };
            } catch (err) {
                return { success: false, message: err.toString() };
            }
        }

        async function grade(userIndices, correctIndices, choiceElements, type) {
            let html = `<h4>${type}éƒ¨åˆ†ï¼š</h4>`;
            const userSet = new Set(userIndices);
            const correctSet = new Set(correctIndices);
            
            if (userSet.size === correctSet.size && [...userSet].every(val => correctSet.has(val))) {
                html += '<p class="feedback-item feedback-correct">âœ… å®Œå…¨æ­£ç¢ºï¼</p>';
            } else {
                const correctlyChosen = [...userSet].filter(i => correctSet.has(i));
                const incorrectlyChosen = [...userSet].filter(i => !correctSet.has(i));
                const missed = [...correctSet].filter(i => !userSet.has(i));

                if (correctlyChosen.length > 0) html += `<p class="feedback-item feedback-correct">ç­”å°éƒ¨åˆ†: ${correctlyChosen.map(i => choiceElements[i].innerText).join(', ')}</p>`;
                if (incorrectlyChosen.length > 0) html += `<p class="feedback-item feedback-wrong">ç­”éŒ¯éƒ¨åˆ†: ${incorrectlyChosen.map(i => choiceElements[i].innerText).join(', ')}</p>`;
                if (missed.length > 0) html += `<p class="feedback-item feedback-missed">éºæ¼éƒ¨åˆ†: ${missed.map(i => choiceElements[i].innerText).join(', ')}</p>`;

                const logData = {
                    timestamp: new Date().toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' }),
                    questionTitle: currentQuestion.title,
                    questionType: type,
                    myAnswer: [...userSet].map(i => choiceElements[i].innerText).join('; '),
                    correctAnswer: [...correctSet].map(i => choiceElements[i].innerText).join('; '),
                    missedAnswer: missed.map(i => choiceElements[i].innerText).join('; ')
                };
                
                const logStatusDiv = document.createElement('div');
                logStatusDiv.className = 'log-status';
                logStatusDiv.innerText = 'æ­£åœ¨è¨˜éŒ„éŒ¯é¡Œ...';
                html += logStatusDiv.outerHTML;

                // éåŒæ­¥è¨˜éŒ„éŒ¯èª¤
                logError(logData).then(result => {
                    const statusDiv = feedbackArea.querySelector('.log-status');
                    if (statusDiv) {
                        statusDiv.innerText = result.success ? 'âœ… éŒ¯é¡Œå·²è¨˜éŒ„' : `âŒ è¨˜éŒ„å¤±æ•—: ${result.message}`;
                    }
                });
            }
            return html;
        }

        nextBtn.addEventListener('click', displayQuestion);

        // --- ä¸»ç¨‹å¼åŸ·è¡Œ ---
        if (!sheetUrl) {
            loadingMessage.innerText = 'âŒ éŒ¯èª¤ï¼šè«‹åœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥æ‚¨çš„ã€Œé¡Œåº«ã€.csv é€£çµï¼';
        } else {
            Papa.parse(sheetUrl, {
                download: true, header: true, skipEmptyLines: true,
                complete: (results) => {
                    allData = results.data.filter(row => row.id && row.id.trim() !== '');
                    if (allData.length > 0) {
                        loadingMessage.style.display = 'none';
                        questionPool = [...Array(allData.length).keys()].sort(() => 0.5 - Math.random());
                        displayQuestion();
                    } else {
                        loadingMessage.style.display = 'none';
                        statusMessage.innerText = 'âŒ éŒ¯èª¤ï¼šè®€å–åˆ°çš„é¡Œåº«æ˜¯ç©ºçš„æˆ–æ ¼å¼ä¸ç¬¦ã€‚';
                        statusMessage.style.display = 'block';
                    }
                },
                error: (err) => {
                    loadingMessage.style.display = 'none';
                    statusMessage.innerText = 'âŒ è®€å–é¡Œåº«å¤±æ•—ï¼è«‹æª¢æŸ¥æ‚¨çš„é€£çµèˆ‡ç™¼ä½ˆè¨­å®šã€‚';
                    statusMessage.style.display = 'block';
                }
            });
        }
    </script>
</body>
</html>
